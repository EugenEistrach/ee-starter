# Organizations & Teams - Frontend Implementation Plan

## Overview

Build UI for organization management with URL-based organization context, matching the backend multi-tenancy architecture.

## Key Requirements

- **URL-based Active Organization**: `/:slug/todos` (org slug is root path)
- **Organization Switcher**: Dropdown/menu to switch between organizations
- **Onboarding Flow**: Force new users to create organization before accessing app
- **Member Management UI**: Single page showing both active members and pending invitations
- **Invitation Flow**: Accept invitations from email links
- **Auto-generated Slugs**: Slug automatically generated from org name by backend
- **Simple UX**: Clear, easy to understand (like Linear/Vercel)
- **Flat File Routing**: TanStack Start flat filenames (e.g., `$slug.todos.tsx`)

## Architecture Decision

Following project architecture:
- New feature slice: `apps/web/src/features/organizations/`
- Shared components: `apps/web/src/shared/organizations/` (only if used 3+ times)
- Routes: `apps/web/src/app/$slug.tsx`, `apps/web/src/app/$slug.todos.tsx`, etc.
- Better Auth client plugin: Add `organizationClient()` to auth-client.ts

## Component Structure

### Features Slice: `apps/web/src/features/organizations/`

```
features/organizations/
├── README.md                           # Feature summary
├── components/                         # Presentational components
│   ├── organization-card.tsx          # Org card for list/switcher
│   ├── member-list-item.tsx           # Member/invitation row with role badge
│   ├── member-role-badge.tsx          # Visual role indicator (owner/admin/member)
│   ├── create-organization-form.tsx   # Form for creating org (name only)
│   └── invite-member-dialog.tsx       # Modal for inviting members
├── views/                              # Smart components (Convex integration)
│   ├── organization-switcher.tsx      # Dropdown with user's orgs
│   ├── members-table.tsx              # Combined members + invitations view
│   └── onboarding-view.tsx            # Force org creation for new users
└── lib/
    └── organization-helpers.ts         # Utilities (if needed)
```

### Routes: `apps/web/src/app/` (Flat File Routing)

```
app/
├── __root.tsx                          # Add org existence check
├── onboarding.tsx                      # NEW: Create first organization
├── accept-invite.tsx                   # NEW: Accept invitation from email
├── $slug.tsx                           # NEW: Org layout (root for org)
├── $slug.index.tsx                     # NEW: Org home/landing
├── $slug.todos.tsx                     # Org-scoped todos
└── $slug.settings.members.tsx          # NEW: Members + invitations management
```

**Note**: Routes like `onboarding`, `accept-invite`, `login`, `signup`, etc. are reserved and can't be used as organization slugs. Backend validates this automatically (auto-synced from route manifest).

## Implementation Overview

### 1. Update Better Auth Client

**File: `apps/web/src/shared/auth/lib/auth-client.ts`**

```typescript
import { convexClient } from '@convex-dev/better-auth/client/plugins'
import { organizationClient } from 'better-auth/client/plugins'  // NEW
import { magicLinkClient } from 'better-auth/client/plugins'
import { createAuthClient } from 'better-auth/react'

export const authClient = createAuthClient({
  plugins: [
    convexClient(),
    magicLinkClient(),
    organizationClient(),  // NEW: Add organization plugin
  ],
})
```

### 2. Root Route - Organization Check

**File: `apps/web/src/app/__root.tsx`**

Add loader to check if user needs onboarding:

```typescript
// Before rendering any protected routes, check:
// 1. Is user authenticated?
// 2. Does user belong to any organization?
// 3. If no → redirect to /onboarding
// 4. If yes → continue to requested route
```

### 3. Onboarding Route

**File: `apps/web/src/app/onboarding.tsx`**

```typescript
// Shows create-organization-form
// Required field: organization name ONLY
// Slug is auto-generated by backend from name
// On success → redirect to /:slug (new org's home)
```

**Uses:**
- `features/organizations/views/onboarding-view.tsx`
- `features/organizations/components/create-organization-form.tsx`

### 4. Organization Layout Route

**File: `apps/web/src/app/$slug.tsx`**

```typescript
// Layout for all org routes
// Loads organization by slug (validates user is member)
// Provides org context to child routes
// Shows header with org switcher
// If org not found or user not member → redirect to first available org or onboarding
```

**Uses:**
- `features/organizations/views/organization-switcher.tsx`

### 5. Organization Home

**File: `apps/web/src/app/$slug.index.tsx`**

```typescript
// Simple landing page for organization root
// Shows: Org name, member count, quick actions
// This is what users see at /:slug
```

### 6. Organization Switcher (in Header)

**Component: `features/organizations/views/organization-switcher.tsx`**

```typescript
// Dropdown menu showing all user's organizations
// Click organization → navigate to /:slug
// "Create Organization" button at bottom
// Current org highlighted
```

**Uses:**
- `features/organizations/components/organization-card.tsx`
- Convex query: `api.organizations.listMyOrganizations`

### 7. Members Management Page (Combined View)

**File: `apps/web/src/app/$slug.settings.members.tsx`**

```typescript
// Single table with two sections (like Linear):
// 1. Active members (with role badges, actions)
// 2. Pending invitations (with email, role, revoke action)
//
// Actions (admin/owner only):
//   - Invite new member (dialog)
//   - Change member role (dropdown)
//   - Remove member (button)
//   - Revoke invitation (button)
//
// Members (non-admin/owner) see read-only view
```

**Uses:**
- `features/organizations/views/members-table.tsx`
- `features/organizations/components/member-list-item.tsx`
- `features/organizations/components/member-role-badge.tsx`
- `features/organizations/components/invite-member-dialog.tsx`

**Single Query**: `api.organizations.getMembers` returns both members and invitations

### 8. Accept Invitation Route

**File: `apps/web/src/app/accept-invite.tsx`**

```typescript
// Receives invitation token from email link
// If not logged in → redirect to sign-up/sign-in with return URL
// If logged in → accept invitation → redirect to /:slug
```

### 9. Update Todos Feature

**File: `apps/web/src/features/todos/views/todos-list.tsx`**

```typescript
// Pass organizationId from route context to Convex queries
// All todo queries now require organizationId
```

**File: `apps/web/src/app/$slug.todos.tsx`**

```typescript
// Get organizationId from route params
// Pass to todos-list component
```

## URL Structure (Flat File Routing)

```
/                                   → Redirect to /:slug (first org)
/onboarding                         → Create first organization
/accept-invite?token=xyz            → Accept invitation

/:slug                              → Organization home (index)
/:slug/todos                        → Organization todos
/:slug/settings/members             → Members + invitations (admin/owner/read-only)
```

**Reserved Routes** (can't be used as org slugs):
- `onboarding`
- `accept-invite`
- `login`
- `signup`
- `reset-password`
- `forgot-password`
- `api`

Auto-synced from frontend routes by Vite plugin (PRFX-70).

## Data Flow Examples

### 1. User Navigates to `/acme/todos`

```
1. Route loader gets slug "acme"
2. Query: api.organizations.getBySlug({ slug: "acme" })
3. Convex validates user is member
4. If valid → render todos with organizationId
5. If invalid → redirect to first available org or onboarding
```

### 2. User Switches Organization

```
1. Click org in switcher
2. Navigate to /:newSlug
3. Route loader loads new org context
4. All child routes use new organizationId
```

### 3. User Invites Member (Admin/Owner Only)

```
1. Open invite dialog in /acme/settings/members
2. Enter email, select role (owner/admin/member)
3. Mutation: api.organizations.inviteMember(...)
4. Backend sends email with invite link
5. Update combined members+invitations table
```

### 4. New User Signs Up

```
1. Sign up via auth form
2. Redirect to /onboarding (via __root.tsx loader)
3. Enter organization name (slug auto-generated by backend)
4. Mutation: api.organizations.create({ name })
5. Backend returns { organization, slug }
6. Redirect to /:slug (new org home)
```

### 5. User Accepts Invitation

```
1. Click link in email → /accept-invite?token=...
2. If not logged in → redirect to sign-in
3. If logged in → mutation to accept invite
4. Redirect to /:slug (invited org home)
```

## State Management

### Organization Context

Create context provider in org layout route:

```typescript
interface OrganizationContext {
  organization: Organization
  userRole: 'owner' | 'admin' | 'member'
  isOwner: boolean
  isAdmin: boolean
}

// Available to all routes under /:slug/
```

### Active Organization

- **Storage**: URL slug (single source of truth)
- **No localStorage/cookies**: Organization is always in URL
- **Switching**: Just navigate to different URL

## Form Validation

### Create Organization Form

- **Name**: Required, 1-100 characters
- **Slug**: NOT SHOWN - Auto-generated by backend from name

**Backend handles:**
- Slug generation (sanitize, lowercase, hyphens)
- Collision resolution (append random suffix if needed)
- Reserved route validation

### Invite Member Form

- **Email**: Required, valid email format
- **Role**: Required, select (owner/admin/member)

## Error Handling

### Organization Not Found

```
User navigates to /invalid-slug
→ Show error: "Organization not found"
→ Redirect to /:firstAvailableSlug
```

### User Not Member

```
User navigates to /not-my-org
→ Show error: "You don't have access to this organization"
→ Redirect to /:firstAvailableSlug
```

### User Has No Organizations

```
User logged in but kicked from all orgs
→ Redirect to /onboarding
→ Force create new organization
```

## Permission-based UI

### Hide/Disable based on Role

```typescript
{(isOwner || isAdmin) && (
  <Button onClick={handleInviteMember}>
    Invite Member
  </Button>
)}

// OR

<Button
  disabled={!isAdmin && !isOwner}
  onClick={handleRemoveMember}
>
  Remove
</Button>
```

### Route Protection

```typescript
// In members settings page
if (!isAdmin && !isOwner) {
  return <div>Read-only view for members</div>
}
```

## UI Components Needed

### New shadcn/ui Components (if not already in @workspace/ui)

- `Badge` - For role badges (owner/admin/member)
- `DropdownMenu` - For organization switcher
- `Dialog` - For invite member modal
- `Avatar` - For member avatars
- `Select` - For role selection
- `Table` - For members + invitations table

### Custom Components

All listed in "Component Structure" section above.

## Members Table Structure (Combined View)

Like Linear, single table with two sections:

```
┌─────────────────────────────────────────────────┐
│ Members & Invitations                    [Invite]│
├─────────────────────────────────────────────────┤
│ Members (3)                                      │
├─────────────────────────────────────────────────┤
│ 👤 John Doe         [OWNER]  [Change] [Remove]  │
│ 👤 Jane Smith       [ADMIN]  [Change] [Remove]  │
│ 👤 Bob Johnson      [MEMBER] [Change] [Remove]  │
├─────────────────────────────────────────────────┤
│ Pending Invitations (2)                          │
├─────────────────────────────────────────────────┤
│ 📧 alice@example.com  [ADMIN]  [Revoke]         │
│ 📧 charlie@example.com [MEMBER] [Revoke]        │
└─────────────────────────────────────────────────┘
```

**Single Query**: `api.organizations.getMembers({ organizationId })` returns:
```typescript
{
  members: [...],      // Active members with user details
  invitations: [...]   // Pending invitations
}
```

## Roles

Better Auth default roles (displayed as badges):
- **Owner** - Full control, can delete organization
- **Admin** - Management permissions, can invite/remove members
- **Member** - Basic member access

Role hierarchy: Owner > Admin > Member

## Testing Checklist

- [ ] Onboarding flow works for new users
- [ ] Organization name input only (no slug field)
- [ ] Slug auto-generated and shown after creation
- [ ] Organization switcher shows all user's orgs
- [ ] URL changes when switching orgs
- [ ] Todos scoped to correct organization
- [ ] Members + invitations table shows both groups
- [ ] Role badges show owner/admin/member correctly
- [ ] Invite, remove, role change work (admin/owner only)
- [ ] Invitation revocation works
- [ ] Accept invitation from email link
- [ ] Non-admin/owner see read-only members view
- [ ] User with no orgs redirected to onboarding
- [ ] Invalid org slug handled gracefully
- [ ] Can't remove last owner/admin

## Design Notes

### Visual Hierarchy

- Current organization prominently displayed in header/sidebar
- Organization switcher easily accessible (top-right or sidebar)
- Role badges clearly visible (color-coded: owner=purple, admin=blue, member=gray)
- Combined members+invitations table with clear section headers

### UX Inspiration

- **Linear**: Clean org switcher, URL-based routing, combined members table
- **Vercel**: Simple team management, clear role display
- **GitHub**: Familiar patterns for member management

### Accessibility

- Keyboard navigation for org switcher
- Screen reader labels for role badges
- Focus management in dialogs
- Clear section headings for members vs invitations

## Backend API Reference

**Organization Operations:**
- `api.organizations.listMyOrganizations()` - Get user's orgs
- `api.organizations.getBySlug({ slug })` - Get org by slug
- `api.organizations.needsOnboarding()` - Check if user needs onboarding
- `api.organizations.create({ name })` - Create org (slug auto-generated)
- `api.organizations.getMembers({ organizationId })` - Get members + invitations

**Member Operations:**
- `api.organizations.inviteMember({ organizationId, email, role })` - Invite member
- `api.organizations.revokeInvitation({ invitationId })` - Revoke invitation
- `api.organizations.removeMember({ organizationId, userId })` - Remove member
- `api.organizations.updateMemberRole({ organizationId, memberId, role })` - Change role

## Future Enhancements (Not in Phase 1)

- Organization logo upload
- Organization settings (rename, delete)
- Member search/filter
- Team support (sub-groups)
- Bulk member operations
- Advanced permissions UI
- Organization analytics/usage
