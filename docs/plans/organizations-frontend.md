# Organizations & Teams - Frontend Implementation Plan

## Overview

Build UI for organization management with URL-based organization context. Backend multi-tenancy is already implemented with Better Auth organizations plugin.

## Current Implementation Status

### Already Implemented ✅

**Backend:**
- `api.organizations.create({ name, logo })` - Creates org with auto-generated slug
- `api.organizations.listAll()` - Returns all user's organizations
- `api.organizations.get({ slug })` - Returns org details INCLUDING members and invites
- Better Auth organization plugin configured on backend
- Slug auto-generation with collision handling

**Frontend:**
- Routes: `/o/$organizationSlug` layout with sidebar, navigation, user dropdown
- `useOrganization()` hook - Fetches org via `useSuspenseQuery(convexQuery(api.organizations.get))`, returns org with members + invites
- `useCurrentUser()` hook - Returns authenticated user
- Route guard validates org access and redirects to `/new-organization` if no orgs
- `authClient` with Better Auth `organizationClient()` plugin already configured
- Todos feature fully org-scoped

### What Needs to Be Built 🚧

**Component Structure** - All in `apps/web/src/features/organizations/`:

**components/** (Presentational):
- `organization-card.tsx` - Org card for switcher dropdown
- `member-list-item.tsx` - Member/invitation row with actions
- `member-role-badge.tsx` - Visual role indicator
- `create-organization-form.tsx` - Form for creating organization
- `invite-member-dialog.tsx` - Modal for inviting members

**views/** (Smart components):
- `organization-switcher.tsx` - Dropdown showing all user's orgs
- `members-table.tsx` - Combined members + pending invitations table

**Routes:**
- `new-organization.tsx` - Replace placeholder with org creation form
- `o.$organizationSlug.settings.tsx` - Replace placeholder with tabbed settings (General/Members/Danger)
- `accept-invite.$invitationId.tsx` - NEW: Accept invitation page

## Architecture Decisions

### Data Fetching Pattern

**For Reading Data:**
- Use `useOrganization()` hook to get current org including members + invites
- Use `useSuspenseQuery(convexQuery(api.organizations.listAll))` for all user's orgs
- Use `authClient.organization.getInvitation()` in route loaders for invitation details

**For Mutations:**
- Use `authClient.organization.*` methods directly (no Convex wrappers needed)
- Create org: `authClient.organization.create()` OR Convex `api.organizations.create()` (both work, use Convex for consistency)
- Invite: `authClient.organization.inviteMember({ email, role })`
- Update role: `authClient.organization.updateMemberRole({ memberId, role })`
- Remove: `authClient.organization.removeMember({ memberIdOrEmail })`
- Cancel invite: `authClient.organization.cancelInvitation({ invitationId })`
- Update org: `authClient.organization.update({ data: { name, logo } })`
- Delete org: `authClient.organization.delete({ organizationId })`
- Leave org: `authClient.organization.leave({ organizationId })`

**For Permissions:**
- Get current role: `authClient.organization.getActiveMemberRole()`
- Check permissions: `authClient.organization.checkRolePermission({ permissions, role })`
- Use for conditional rendering (show/hide buttons based on role)

### URL Structure

```
/o/$organizationSlug              → Organization layout (sidebar, nav)
/o/$organizationSlug/todos        → Todos (already implemented)
/o/$organizationSlug/settings     → Settings tabs (General/Members/Danger)
/new-organization                 → Create new organization
/accept-invite/$invitationId      → Accept invitation from email
```

**Route Guard:** `/o/$organizationSlug` loader checks user has access to org, redirects to `/new-organization` if no orgs exist.

## Component Implementation Details

### 1. Organization Switcher

**Location:** Enhance `ChevronsUpDown` button area in `o.$organizationSlug.tsx` sidebar

**Data:**
```typescript
const organizations = useSuspenseQuery(convexQuery(api.organizations.listAll, {}))
const currentOrg = useOrganization()
```

**UI:**
- Dropdown menu triggered by org name/logo
- List all organizations with org cards
- Highlight current organization
- "+ New Organization" button at bottom → navigate to `/new-organization`
- Click org → navigate to `/o/{slug}`

**Components used:** `organization-card.tsx`

### 2. New Organization Form

**Location:** `apps/web/src/app/new-organization.tsx`

**Fields:**
- Organization name (required)
- Logo URL (optional)
- Slug is auto-generated by backend

**Mutation:**
```typescript
const createOrg = useMutation(api.organizations.create)
await createOrg({ name, logo })
// Backend generates slug and returns organization
// Redirect to /o/{slug}
```

**Components used:** `create-organization-form.tsx`

### 3. Settings Page - General Tab

**Location:** `apps/web/src/app/o.$organizationSlug.settings.tsx`

**Data:**
```typescript
const organization = useOrganization()
```

**Form fields:**
- Organization name
- Logo URL

**Mutation:**
```typescript
await authClient.organization.update({
  data: { name, logo }
})
```

**Permissions:** Only owner/admin can edit

### 4. Settings Page - Members Tab

**Location:** Same file, Members tab

**Data:**
```typescript
const organization = useOrganization()
// organization.members: [{ id, name, email, role }]
// organization.invites: [{ id, email, role, status, expiresAt }]
```

**UI - Single Combined Table:**

```
┌─────────────────────────────────────────────────────┐
│ Members & Invitations                      [Invite] │
├─────────────────────────────────────────────────────┤
│ Active Members (3)                                   │
├─────────────────────────────────────────────────────┤
│ 👤 John Doe      [OWNER]   [Change] [Remove]        │
│ 👤 Jane Smith    [ADMIN]   [Change] [Remove]        │
│ 👤 Bob Johnson   [MEMBER]  [Change] [Remove]        │
├─────────────────────────────────────────────────────┤
│ Pending Invitations (2)                              │
├─────────────────────────────────────────────────────┤
│ 📧 alice@ex.com  [ADMIN]   [Resend] [Revoke]        │
│ 📧 bob@ex.com    [MEMBER]  [Resend] [Revoke]        │
└─────────────────────────────────────────────────────┘
```

**Actions (owner/admin only):**

Invite:
```typescript
await authClient.organization.inviteMember({
  email,
  role, // 'owner' | 'admin' | 'member'
})
```

Update role:
```typescript
await authClient.organization.updateMemberRole({
  memberId,
  role,
})
```

Remove member:
```typescript
await authClient.organization.removeMember({
  memberIdOrEmail,
})
```

Revoke invitation:
```typescript
await authClient.organization.cancelInvitation({
  invitationId,
})
```

**Permissions:**
```typescript
const { data: memberRole } = await authClient.organization.getActiveMemberRole()
const canManageMembers = authClient.organization.checkRolePermission({
  permissions: { member: ['create', 'delete'] },
  role: memberRole?.role
})
```

**Components used:** `members-table.tsx`, `member-list-item.tsx`, `member-role-badge.tsx`, `invite-member-dialog.tsx`

### 5. Settings Page - Danger Zone Tab

**Location:** Same file, Danger Zone tab

**Actions:**

Delete organization:
```typescript
await authClient.organization.delete({
  organizationId: organization.id
})
// Redirect to first available org or /new-organization
```

Leave organization:
```typescript
await authClient.organization.leave({
  organizationId: organization.id
})
// Redirect to first available org or /new-organization
```

**Permissions:** Only owner can delete, any member can leave

### 6. Accept Invitation Route

**File:** `apps/web/src/app/accept-invite.$invitationId.tsx`

**Route Loader:**
```typescript
loader: async ({ params }) => {
  const invitation = await authClient.organization.getInvitation({
    id: params.invitationId
  })
  return { invitation }
}
```

**UI:**
- Show organization name, role, inviter info
- Accept button
- Reject button

**Actions:**

Accept:
```typescript
await authClient.organization.acceptInvitation({
  invitationId
})
// Redirect to /o/{slug}
```

Reject:
```typescript
await authClient.organization.rejectInvitation({
  invitationId
})
// Redirect to first available org or /new-organization
```

## Roles & Permissions

Better Auth default roles:
- **owner** - Full control, can delete organization
- **admin** - Can invite/remove members, change roles
- **member** - Basic access

**Permission Checking Pattern:**
```typescript
// Get current user's role
const { data: memberRole } = await authClient.organization.getActiveMemberRole()

// Check what role can do (client-side, for UI only)
const canInvite = authClient.organization.checkRolePermission({
  permissions: { member: ['create'] },
  role: memberRole?.role
})

// Use for conditional rendering
{canInvite && <Button>Invite Member</Button>}
```

**Important:** Client-side checks are for UI only. Backend enforces permissions on all operations.

## Form Validation

### Create Organization
- Name: Required, 1-100 characters
- Logo: Optional, valid URL
- Slug: Auto-generated by backend (not shown in form)

### Invite Member
- Email: Required, valid email format
- Role: Required, select from owner/admin/member

## Error Handling

### Organization Not Found
```typescript
// Route guard handles this
// Redirects to /new-organization if user has no orgs
```

### User Not Member
```typescript
// Route guard validates membership
// Redirects to first available org or /new-organization
```

### Permission Denied
```typescript
// Better Auth returns error
// Show toast notification
// Disable buttons based on role checks
```

## UI Components Needed

**From `@workspace/ui`:**
- Badge - Role badges
- DropdownMenu - Org switcher
- Dialog - Invite dialog
- Avatar - User avatars
- Select - Role selection
- Table - Members table
- Tabs - Settings tabs
- Card - Layout
- Button - Actions
- Form/Input - Forms

**Custom Components:**
All in `features/organizations/components/` and `features/organizations/views/`

## State Management

### Organization Context
- **Source of truth:** URL slug parameter
- **Access pattern:** `useOrganization()` hook
- **Switching:** Navigate to different URL
- **No localStorage/cookies:** Organization always in URL

### Active Organization Data
```typescript
const organization = useOrganization()
// Returns:
// {
//   id: string (cast to Id<'organization'>)
//   name: string
//   slug: string
//   logo: string | null
//   members: Array<{ id, name, email, role }>
//   invites: Array<{ id, email, role, status, expiresAt }>
// }
```

## Testing Checklist

- [ ] Organization switcher shows all user's orgs
- [ ] Can create new organization with name only (slug auto-generated)
- [ ] URL changes when switching orgs
- [ ] Settings General tab: can update org name/logo
- [ ] Settings Members tab: shows active members and pending invites
- [ ] Can invite new members (owner/admin only)
- [ ] Can change member roles (owner/admin only)
- [ ] Can remove members (owner/admin only)
- [ ] Can revoke invitations (owner/admin only)
- [ ] Members (non-admin) see read-only view
- [ ] Settings Danger tab: can delete org (owner only)
- [ ] Settings Danger tab: can leave org (any member)
- [ ] Accept invitation from email link works
- [ ] Reject invitation works
- [ ] User with no orgs redirected to /new-organization
- [ ] Permission checks hide/disable actions based on role

## Design Guidelines

### Visual Hierarchy
- Organization name/logo prominent in switcher
- Role badges color-coded (owner=purple, admin=blue, member=gray)
- Combined members+invitations table with clear sections
- Danger zone actions clearly separated (red theme)

### UX Patterns
- URL-based org selection (shareable links)
- Optimistic updates for mutations
- Toast notifications for success/error
- Confirmation dialogs for destructive actions
- Loading states during data fetching

### Accessibility
- Keyboard navigation for org switcher
- Screen reader labels for role badges
- Focus management in dialogs
- Clear section headings
- ARIA labels for icon buttons

## Implementation Order

1. **Organization Switcher** - Enhance sidebar with org dropdown
2. **New Organization Form** - Replace placeholder route
3. **Settings General Tab** - Org name/logo editing
4. **Settings Members Tab** - Combined members + invites table
5. **Settings Danger Tab** - Delete/leave actions
6. **Accept Invitation Route** - New route for email links

## Notes

- All mutations refetch relevant queries automatically (React Query handles this)
- Use `useSuspenseQuery` for data that must exist before render
- Use `useMutation` from Convex for Convex mutations
- Use `authClient` directly for Better Auth mutations
- Toast notifications for all success/error states
- Confirm dialogs for destructive actions (delete, remove, leave)
